<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Star Trek Episode Companion - Episode-Build 52</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #02030a;
      --bg-alt: #050818;
      --bg-panel: #0b1024;
      --bg-panel-soft: #101632;
      --accent-gold: #f8c66a;
      --accent-gold-soft: rgba(248,198,106,0.2);
      --accent-blue: #64d3ff;
      --accent-blue-soft: rgba(100,211,255,0.18);
      --accent-rose: #ff7b9c;
      --rail-a: #f2975c;
      --rail-b: #f4d96d;
      --rail-c: #8fd3ff;
      --border-soft: #2a3556;
      --border-strong: #475483;
      --text-main: #f7f8ff;
      --text-muted: #b3bee4;
      --text-soft: #8c94b7;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at -10% 0%, rgba(255,123,156,0.28), transparent 55%),
        radial-gradient(circle at 110% 100%, rgba(100,211,255,0.26), transparent 55%),
        linear-gradient(155deg, #02030a 0%, #04061a 40%, #02030a 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 18px 12px;
      font-size: 16px;
    }
    .shell {
      max-width: 1240px;
      width: 100%;
      min-height: 640px;
      background:
        radial-gradient(circle at 0% 0%, rgba(100,211,255,0.16), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(242,151,92,0.2), transparent 60%),
        linear-gradient(145deg, #050920, #050717);
      border-radius: 26px;
      border: 2px solid rgba(112,138,235,0.85);
      box-shadow:
        0 26px 75px rgba(0,0,0,0.95),
        0 0 0 1px rgba(7,9,22,0.95),
        0 0 60px rgba(100,211,255,0.3),
        0 0 80px rgba(242,151,92,0.4);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .shell-header {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.1fr);
      gap: 18px;
      padding: 14px 18px 10px;
      border-bottom: 1px solid rgba(71,84,135,0.85);
      background:
        linear-gradient(180deg, rgba(10,14,39,0.96), rgba(6,8,24,0.96));
    }
    @media (max-width: 900px) {
      .shell-header {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .brand-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-pill {
      padding: 4px 13px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 10% 0%, rgba(248,198,106,0.3), #151a3a);
      border: 1px solid rgba(166,141,255,0.9);
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-muted);
      box-shadow:
        0 0 0 1px rgba(7,9,27,0.96),
        0 0 16px rgba(248,198,106,0.75);
    }
    .brand-dot {
      width: 18px;
      height: 18px;
      border-radius: 12px;
      background:
        conic-gradient(from 0deg, #f2975c, #f4d96d, #8fd3ff, #ff7b9c, #f2975c);
      box-shadow:
        0 0 18px rgba(242,151,92,1),
        0 0 28px rgba(100,211,255,0.85);
    }
    .brand-caption {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--accent-blue);
    }
    .brand-title {
      font-size: 24px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--accent-gold);
      text-shadow:
        0 0 2px rgba(0,0,0,0.9),
        0 0 12px rgba(0,0,0,0.9);
    }
    .brand-sub {
      font-size: 17px;
      color: #f5f5fa;
    }
    .brand-nav {
      margin-top: 6px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .data-block {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      font-size: 12px;
      color: var(--text-soft);
      text-align: right;
    }
    
    
    .data-block a {
      color: var(--accent-blue);
      text-decoration: none;
    }
    .data-block a:hover {
      text-decoration: underline;
    }
    .data-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 11px;
      color: var(--text-muted);
    }
    .strip {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px 18px 10px;
      background:
        linear-gradient(180deg, rgba(10,14,38,0.96), rgba(6,9,30,0.96));
      border-bottom: 1px solid rgba(65,79,131,0.9);
    }
    .strip-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }
    .strip-label-main {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      color: var(--text-muted);
    }
    .strip-label-sub {
      font-size: 12px;
      color: var(--text-soft);
    }
    .back-link {
      background: none;
      border: none;
      padding: 0;
      margin-right: 10px;
      font-size: 12px;
      color: var(--accent-blue);
      cursor: pointer;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .console-nav {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      font-size: 12px;
    }
    .console-back-link {
      font-size: 12pt;
      font-family: "Roboto", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #f8c66a;
      border: 1px solid rgba(255,255,255,0.85);
      border-radius: 999px;
      padding: 3px 12px 4px;
      background: transparent;
    }
    .console-back-link:hover {
      background: rgba(248,198,106,0.15);
    }



    .series-strip {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 12px 16px;
      padding: 10px 0 16px;
    }
    .series-info-body {
      margin-top: 8px;
      font-size: 12pt;
      color: #ffffff;
      line-height: 1.5;
      max-width: 960px;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }
    #series-info .strip-label-main {
      font-size: 14pt;
      color: #f8c66a;
      text-align: center;
    }
    #series-info .strip-label-sub {
      font-size: 12pt;
      color: #ffffff;
      text-align: center;
    }
    .search-body {
      margin-top: 8px;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }
    .search-input {
      width: 100%;
      max-width: 520px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(248,198,106,0.8);
      background: rgba(8,8,24,0.9);
      color: var(--text-main);
      font-size: 13px;
    }
    .search-input:focus {
      outline: none;
      box-shadow: 0 0 0 1px rgba(248,198,106,0.9), 0 0 16px rgba(248,198,106,0.85);
    }
    .search-help {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-soft);
    }
    .search-results {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      align-items: stretch;
    }
    .search-result-item {
      width: 100%;
      max-width: none;
      padding: 6px 10px;
      border-radius: 8px;
      background: rgba(8,8,24,0.85);
      border: 1px solid rgba(248,198,106,0.5);
      color: var(--text-main);
      font-size: 12px;
      text-align: left;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .search-result-main {
      font-weight: 600;
    }
    .search-result-meta {
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }



    .series-chip {
      position: relative;
      flex-shrink: 0;
      min-width: 130px;
      padding: 9px 22px 11px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 10% 0%, rgba(255,255,255,0.22), transparent 60%),
        linear-gradient(145deg, #fff4c7, #f0c664 40%, #9b6518 100%);
      border: 1px solid rgba(28,18,4,0.96);
      color: #1f1204;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow:
        0 4px 14px rgba(0,0,0,0.9),
        0 0 0 1px rgba(0,0,0,0.9),
        0 0 24px rgba(248,198,106,0.9),
        inset 0 0 0 1px rgba(255,255,255,0.45),
        inset 0 16px 26px rgba(255,255,255,0.18);
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        border-color 0.1s ease,
        background 0.12s ease,
        filter 0.12s ease;
      text-align: center;
      backdrop-filter: blur(2px);
    }
    .series-chip span {
      display: block;
      font-size: 10px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-top: 2px;
    }
    .series-chip::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background:
        linear-gradient(120deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.18) 18%, transparent 40%),
        radial-gradient(circle at 0 0, rgba(100,211,255,0.35), transparent 60%);
      opacity: 0;
      transform: translateX(-40%);
      transition: opacity 0.12s ease, transform 0.25s ease;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .series-chip:hover::before {
      opacity: 1;
      transform: translateX(10%);
    }
    .series-chip:hover {
      transform: translateY(-3px) scale(1.02);
      border-color: rgba(255,255,255,0.95);
      box-shadow:
        0 8px 22px rgba(0,0,0,0.98),
        0 0 30px rgba(248,198,106,1);
      filter: saturate(1.08);
    }
    .series-chip.active {
      background:
        radial-gradient(circle at 16% 0%, rgba(255,255,255,0.3), transparent 55%),
        linear-gradient(145deg, #fff7cf, #f3cb6a 40%, #af7420 100%);
      border-color: rgba(255,255,255,0.95);
      color: #140b03;
      box-shadow:
        0 5px 20px rgba(0,0,0,0.98),
        0 0 32px rgba(248,198,106,1),
        inset 0 0 0 1px rgba(255,255,255,0.65);
    }

    .series-chip.active span {
      color: #251021;
    }
    
    .season-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 4px 2px 4px;
      margin-bottom: 4px;
      min-height: 40px;
    }
    .season-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: #76a5af;
      color: #140b03;
      box-shadow:
        0 3px 10px rgba(0,0,0,0.9),
        0 0 12px rgba(109,128,214,0.6);
      font-size: 13px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease, background 0.08s ease;
    }
    .season-chip:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.7);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.95),
        0 0 18px rgba(139,158,234,0.9);
    }
    .season-chip.active {
      background:
        radial-gradient(circle at 16% 0%, rgba(255,255,255,0.3), transparent 55%),
        linear-gradient(145deg, #fff7cf, #f3cb6a 40%, #af7420 100%);
      border-color: rgba(255,255,255,0.95);
      color: #140b03;
      box-shadow:
        0 5px 20px rgba(0,0,0,0.98),
        0 0 32px rgba(248,198,106,1),
        inset 0 0 0 1px rgba(255,255,255,0.65);
    }
    .season-chip.active span {
      color: #251021;
    }
    .episodes-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      max-height: 280px;
      overflow-y: auto;
      padding: 4px 2px 6px;
      scrollbar-width: thin;
    }
    .episode-card {
      position: relative;
      flex-shrink: 0;
      min-width: 220px;
      max-width: 320px;
      padding: 9px 11px;
      border-radius: 18px;
      background:
        linear-gradient(135deg, #101633, #060b20);
      border: 1px solid rgba(109,128,214,0.95);
      cursor: pointer;
      box-shadow:
        0 3px 12px rgba(0,0,0,0.95),
        0 0 18px rgba(109,128,214,0.6);
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease, background 0.08s ease;
      font-size: 14px;
    }
    .episode-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at 0 0, rgba(100,211,255,0.26), transparent 65%);
      opacity: 0;
      transition: opacity 0.08s ease;
    }
    .episode-card:hover::before {
      opacity: 1;
    }
    .episode-card:hover {
      transform: translateY(-2px);
      border-color: rgba(139,158,234,1);
      box-shadow:
        0 5px 18px rgba(0,0,0,0.98),
        0 0 24px rgba(109,128,214,0.9);
      background:
        linear-gradient(135deg, #141c3d, #070e24);
    }
    .episode-card.active {
      background:
        radial-gradient(circle at 0 0, rgba(248,198,106,0.32), transparent 70%),
        linear-gradient(135deg, #192143, #0b112a);
      border-color: var(--accent-gold);
      box-shadow:
        0 0 0 1px rgba(248,198,106,0.9),
        0 0 26px rgba(248,198,106,0.95);
    }
    .episode-line-1 {
      font-size: 15px;
      margin-bottom: 3px;
    }
    .episode-line-2 {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }
    .episode-tag {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-blue);
    }
    .episode-meta {
      font-size: 11px;
      color: var(--text-soft);
    }
    .console {
      flex: 1;
      padding: 10px 18px 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
      gap: 14px;
    }
    @media (max-width: 980px) {
      .console {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .console-main {
      background:
        radial-gradient(circle at -10% 0%, var(--accent-blue-soft), transparent 70%),
        radial-gradient(circle at 110% 100%, var(--accent-gold-soft), transparent 65%),
        linear-gradient(145deg, #080d24, #050716);
      border-radius: 22px;
      border: 1px solid rgba(76,93,158,0.95);
      box-shadow:
        0 14px 34px rgba(0,0,0,0.98),
        0 0 22px rgba(100,211,255,0.35);
      padding: 12px 13px 13px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .console-side {
      background:
        radial-gradient(circle at 100% 0%, rgba(255,123,156,0.26), transparent 70%),
        linear-gradient(145deg, #0a0f26, #050717);
      border-radius: 22px;
      border: 1px solid rgba(90,102,170,0.95);
      box-shadow:
        0 14px 34px rgba(0,0,0,0.98),
        0 0 20px rgba(255,123,156,0.35);
      padding: 12px 13px 13px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      border-bottom: 1px solid rgba(84,96,156,0.95);
      padding-bottom: 4px;
    }
    .console-title {
      font-size: 17px;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      color: var(--accent-gold);
    }
    .console-sub {
      font-size: 13px;
      color: var(--text-soft);
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      font-size: 13px;
    }
    .meta-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background:
        linear-gradient(135deg, #111735, #070d22);
      border: 1px solid rgba(118,133,212,0.9);
      box-shadow:
        0 2px 9px rgba(0,0,0,0.9),
        0 0 14px rgba(100,211,255,0.32);
    }
    .meta-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }
    .meta-value {
      font-size: 13px;
      color: var(--text-main);
      font-weight: 500;
    }
    .summary {
      font-size: 14px;
      color: var(--text-muted);
    }
    .story-stack {
      display: flex;
      flex-direction: column;
      gap: 7px;
      margin-top: 2px;
    }
    .story-card {
      border-radius: 14px;
      padding: 8px 10px;
      background:
        radial-gradient(circle at 0 0, rgba(248,198,106,0.28), transparent 70%),
        linear-gradient(145deg, #141933, #080d22);
      border: 1px solid rgba(248,198,106,0.4);
      box-shadow:
        0 3px 12px rgba(0,0,0,0.98),
        0 0 18px rgba(248,198,106,0.45);
    }
    .story-card h3 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--accent-gold);
      margin-bottom: 3px;
    }
    .story-card p {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-muted);
    }
    .block-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-soft);
      margin-bottom: 3px;
    }

    .block-label-accent {
      font-size: 13px;
      color: var(--accent-gold);
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }
    .chip {
      display: inline-block;
      padding: 2px 4px;
      border-radius: 0;
      background: none;
      border: none;
      font-size: 14px;
      color: var(--accent-gold);
      cursor: pointer;
      white-space: nowrap;
      text-decoration: underline;
    }
    .chip:hover {
      color: #ffe6a8;
      text-decoration: underline;
    }
    .text-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .notes-stack {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .note-card {
      border-radius: 12px;
      border: 1px solid rgba(107,124,215,0.95);
      padding: 7px 9px 8px;
      background:
        radial-gradient(circle at 0 0, rgba(100,211,255,0.26), transparent 70%),
        linear-gradient(135deg, #111730, #080f22);
      box-shadow:
        0 3px 12px rgba(0,0,0,0.98),
        0 0 18px rgba(100,211,255,0.5);
    }
    .note-card h4 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: #cfd6ff;
      margin-bottom: 3px;
    }
    .note-card p {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-muted);
    }
    .placeholder {
      font-size: 14px;
      color: var(--text-soft);
    }
    .error-text {
      font-size: 14px;
      color: #ffb3b3;
    }
    .bio-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .bio-modal.active {
      display: flex;
    }
    .bio-backdrop {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0 0, rgba(0,0,0,0.9), rgba(0,0,0,0.98));
    }
    .bio-frame {
      position: relative;
      max-width: 540px;
      width: calc(100% - 40px);
      padding: 1px;
      border-radius: 22px;
      background:
        conic-gradient(from 0deg, rgba(242,151,92,0.9), rgba(244,217,109,0.9), rgba(100,211,255,0.9), rgba(255,123,156,0.9), rgba(242,151,92,0.9));
      box-shadow:
        0 0 0 1px rgba(6,10,30,0.95),
        0 20px 44px rgba(0,0,0,0.98),
        0 0 40px rgba(100,211,255,0.9),
        0 0 52px rgba(242,151,92,0.9);
      z-index: 1001;
    }
    .bio-panel {
      border-radius: 21px;
      background:
        radial-gradient(circle at 0 0, rgba(248,198,106,0.26), transparent 70%),
        linear-gradient(145deg, #050814, #050712);
      border: 1px solid rgba(248,198,106,0.8);
      box-shadow:
        inset 0 0 0 1px rgba(8,11,30,0.96),
        inset 0 18px 38px rgba(255,255,255,0.03);
      padding: 14px 15px 15px;
    }
    .bio-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 6px;
      border-bottom: 1px solid rgba(93,107,180,0.95);
      padding-bottom: 5px;
    }
    .bio-name {
      font-size: 17px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #fff5df;
    }
    .bio-role {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 7px;
    }
    .bio-summary {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .bio-close-btn {
      border: none;
      border-radius: 999px;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background:
        linear-gradient(135deg, #181f35, #0b1023);
      color: #f5f7ff;
      font-size: 16px;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(90,106,183,0.95),
        0 2px 8px rgba(0,0,0,0.85);
    }
    .bio-close-btn:hover {
      background:
        linear-gradient(135deg, #212a46, #101735);
    }
    .bio-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-soft);
      margin-bottom: 2px;
    }
    .bio-name-raw {
      font-size: 13px;
      color: var(--text-main);
      margin-bottom: 4px;
    }
    .bio-fallback {
      margin-top: 8px;
      display: none;
      border-top: 1px dashed rgba(82,94,154,0.95);
      padding-top: 7px;
    }
  
    .hidden {
      display: none !important;
    }

    
</style>
</head>
<body>
  <div class="shell">
    <header class="shell-header">
      <div class="brand-block">
        <div class="brand-row">
          <div class="brand-dot"></div>
          <div class="brand-pill">Star Trek Episode Companion</div>
        </div>
        <div class="brand-caption"></div>
        <div class="brand-title">Episode console</div>
        <div class="brand-sub" id="brand-sub">Select a series, skim the episode deck, then deep-dive into story beats, characters, ethics, continuity, and themes.</div>
        <div class="brand-nav" id="brand-nav">
          <button id="detail-back-episodes" type="button" class="back-link console-back-link">← Back to episodes</button>
          <button id="detail-back-series" type="button" class="back-link console-back-link">← Back to series</button>
        </div>
      </div>
      
    </header>

    <section id="series-section" class="strip">
      <div class="strip-label-row">
        <div class="strip-label-main">Series</div>
        <div id="series-status" class="strip-label-sub">Waiting for data…</div>
      </div>
      <div id="series-strip" class="series-strip"></div>
    </section>


    

    <section id="search-section" class="strip">
      <div class="strip-label-row">
        <div class="strip-label-main">Search episodes</div>
        <div class="strip-label-sub">Start typing a series name, episode title, or ID</div>
      </div>
      <div class="search-body">
        <input id="search-input" type="text" class="search-input" placeholder="Search by series (TNG), title (The Man Trap), or ID (toss1e1)…" autocomplete="off">
        <div id="search-help" class="search-help">Type at least 2 characters to see matching series and episodes.</div>
        <div id="search-results" class="search-results"></div>
      </div>
    </section>
    <section id="episodes-section" class="strip">
      <div class="strip-label-row">
        <div class="strip-label-main">Episodes</div>
        <div id="episodes-panel-subtitle" class="strip-label-sub">Select a series to view seasons.</div>
      </div>
      <div id="season-row" class="season-row">
        <div class="placeholder">Select a series above to view seasons.</div>
      </div>
      <div id="episodes-strip" class="episodes-strip">
        <div class="placeholder">Select a season to view episodes.</div>
      </div>
    </section>


    

    <section id="details-section" class="console">
      <div class="console-main">
        <div class="console-header">
          <div id="console-title" class="console-title">No episode selected</div>
          <div id="console-sub" class="console-sub">Choose a series and an episode above.</div>
        </div>
        <div id="episode-meta" class="meta-row"></div>
        <div id="episode-summary" class="summary">
          <div class="placeholder">When you select an episode, an overview and story structure will appear here.</div>
        </div>
        <div id="episode-story" class="story-stack"></div>
      </div>
      <div class="console-side">
        <div>
          <div class="block-label">Key Characters</div>
          <div id="chip-key" class="chip-row"></div>
        </div>
        <div>
          <div class="block-label">Guest Characters</div>
          <div id="chip-guest" class="chip-row"></div>
        </div>
        <div>
          <div class="block-label">Antagonists</div>
          <div id="chip-ant" class="chip-row"></div>
        </div>
        <div id="ethical-block">
          <div class="block-label">Ethical Issues</div>
          <ul id="ethical-list" class="text-list"></ul>
        </div>
        <div id="notes-block" class="notes-stack"></div>
      </div>
    </section>
  </div>

  <div id="bio-modal" class="bio-modal">
    <div id="bio-backdrop" class="bio-backdrop"></div>
    <div class="bio-frame">
      <div class="bio-panel">
        <div class="bio-header-row">
          <div id="bio-name" class="bio-name"></div>
          <button id="bio-close" class="bio-close-btn" type="button">×</button>
        </div>
        <div id="bio-role" class="bio-role"></div>
        <div id="bio-summary" class="bio-summary"></div>
        <div id="bio-fallback" class="bio-fallback">
          <div class="bio-label">Requested name</div>
          <div id="bio-name-raw" class="bio-name-raw"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = "https://raw.githubusercontent.com/BigBird7827/Epi-Trek/main/Episodes/Epi-Trek";
    const EPISODE_URLS = {
      "TOS": "https://raw.githubusercontent.com/BigBird7827/Epi-Trek/main/Episodes/TOS-Episodes.json",
      "TNG": "https://raw.githubusercontent.com/BigBird7827/Epi-Trek/main/Episodes/TNG-Episodes.json",
      "TAS": "https://raw.githubusercontent.com/BigBird7827/Epi-Trek/main/Episodes/TAS-Episodes.json"
    };
    const SUMMARY_URL = "https://raw.githubusercontent.com/BigBird7827/Epi-Trek/main/Summaries/summaries.json";
    const BIO_URL = "https://raw.githubusercontent.com/BigBird7827/Epi-Trek/main/Summaries/summaries.json";

    let allEpisodes = [];
    let episodesBySeries = {};
    let currentSeries = null;
    let currentSeason = null;
    let currentEpisodeID = null;
    let summariesById = {};

    let searchIndex = [];


    const ALL_SERIES = ["TOS","TAS","TNG","DS9","VOY","ENT","DIS","PIC","SNW","LD","PRO"];

    const TAGLINE_TEXT = "Select a series, skim the episode deck, then deep-dive into story beats, characters, ethics, continuity, and themes.";


    let biosByKey = {};
    let biosLoaded = false;

    function showPage(page) {
      const seriesSection = document.getElementById("series-section");
      const searchSection = document.getElementById("search-section");
      const searchResultsSection = document.getElementById("search-results-section");
      const episodesSection = document.getElementById("episodes-section");
      const detailsSection = document.getElementById("details-section");
      const brandSub = document.getElementById("brand-sub");
      const brandNav = document.getElementById("brand-nav");
      const backEpisodes = document.getElementById("detail-back-episodes");
      const backSeries = document.getElementById("detail-back-series");

      if (seriesSection) {
        seriesSection.classList.toggle("hidden", page !== "series");
      }
      if (searchSection) {
        searchSection.classList.toggle("hidden", page !== "series");
      }
      if (searchResultsSection) {
        searchResultsSection.classList.toggle("hidden", page !== "series");
      }
      if (episodesSection) {
        episodesSection.classList.toggle("hidden", page !== "episodes");
      }
      if (detailsSection) {
        detailsSection.classList.toggle("hidden", page !== "details");
      }

      if (brandSub) {
        if (page === "series") {
          brandSub.textContent = TAGLINE_TEXT;
        } else {
          brandSub.textContent = "";
        }
      }

      if (brandNav && backEpisodes && backSeries) {
        if (page === "series") {
          brandNav.style.display = "none";
        } else if (page === "episodes") {
          brandNav.style.display = "flex";
          backEpisodes.style.display = "none";
          backSeries.style.display = "inline-flex";
        } else if (page === "details") {
          brandNav.style.display = "flex";
          backEpisodes.style.display = "inline-flex";
          backSeries.style.display = "inline-flex";
        }
      }
    }

    

    

    


    
    function buildSearchIndex() {
      const index = [];
      ALL_SERIES.forEach(series => {
        index.push({
          type: "series",
          series: series,
          label: series + " (series)"
        });
      });
      allEpisodes.forEach(ep => {
        index.push({
          type: "episode",
          id: ep.ID,
          series: ep.Series || "",
          season: ep.Season,
          episode: ep.Episode,
          title: ep.Title || "",
          label: (ep.Series || "") + " S" + ep.Season + "E" + ep.Episode + " – " + (ep.Title || "")
        });
      });
      searchIndex = index;
    }

    function renderSearchResults(results) {
      const container = document.getElementById("search-results");
      const help = document.getElementById("search-help");
      if (!container || !help) return;
      container.innerHTML = "";
      if (!results || results.length === 0) {
        help.textContent = "No matches. Try a different series name, title, or ID.";
        return;
      }
      help.textContent = "Showing " + results.length + " result" + (results.length === 1 ? "" : "s") + ".";
      results.slice(0, 30).forEach(item => {
        const div = document.createElement("div");
        div.className = "search-result-item";
        const main = document.createElement("div");
        main.className = "search-result-main";
        const meta = document.createElement("div");
        meta.className = "search-result-meta";

        if (item.type === "series") {
          main.textContent = item.label;
          meta.textContent = "Jump to " + item.series + " episode list";
        } else {
          main.textContent = item.label;
          meta.textContent = "Open episode details";
        }

        div.appendChild(main);
        div.appendChild(meta);

        div.addEventListener("click", () => {
          if (item.type === "series") {
            selectSeries(item.series);
          } else if (item.type === "episode") {
            if (item.series) {
              selectSeries(item.series);
            }
            if (item.id) {
              selectEpisode(item.id);
            }
          }
        });

        container.appendChild(div);
      });
    }

    function handleSearchInput(event) {
      const q = (event.target.value || "").trim().toLowerCase();
      const help = document.getElementById("search-help");
      const container = document.getElementById("search-results");
      if (!help || !container) return;
      if (q.length < 2) {
        help.textContent = "Type at least 2 characters to see matching series and episodes.";
        container.innerHTML = "";
        return;
      }
      const results = searchIndex.filter(item => {
        const haystack = item.label.toLowerCase();
        return haystack.includes(q);
      });
      renderSearchResults(results);
    }
function groupEpisodesBySeries(episodes) {
      const grouped = {};
      episodes.forEach(ep => {
        const key = ep.Series || "Unknown";
        if (!grouped[key]) {
          grouped[key] = [];
        }
        grouped[key].push(ep);
      });
      Object.keys(grouped).forEach(key => {
        grouped[key].sort((a, b) => {
          if (a.Season !== b.Season) {
            return a.Season - b.Season;
          }
          return a.Episode - b.Episode;
        });
      });
      return grouped;
    }

    
    function renderSeriesMenuButtons() {
      const container = document.getElementById("series-main-buttons");
      if (!container) {
        return;
      }
      container.innerHTML = "";
      const keys = ALL_SERIES;
      if (keys.length === 0) {
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "No series available.";
        container.appendChild(div);
        return;
      }
      keys.forEach(key => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "series-chip";
        btn.dataset.series = key;
        btn.innerHTML = key + "<span>Series</span>";
        btn.addEventListener("click", () => {
          selectSeries(key);
        });
        container.appendChild(btn);
      });
    }

    function renderSeriesStrip() {
      const container = document.getElementById("series-strip");
      const status = document.getElementById("series-status");
      container.innerHTML = "";
      const keys = ALL_SERIES;
      if (keys.length === 0) {
        const span = document.createElement("span");
        span.className = "placeholder";
        span.textContent = "No series found in data.";
        container.appendChild(span);
        if (status) {
          status.textContent = "No series available.";
        }
        return;
      }
      keys.forEach(key => {
        const chip = document.createElement("button");
        chip.className = "series-chip";
        chip.dataset.series = key;
        chip.textContent = key;
        chip.addEventListener("click", () => selectSeries(key));
        container.appendChild(chip);
      });
      if (status) {
        status.textContent = "Loaded " + keys.length + " series. Select one to begin.";
      }
    }

    
    function selectSeries(seriesKey) {
      currentSeries = seriesKey;
      currentSeason = null;
      currentEpisodeID = null;

      const chips = document.querySelectorAll(".series-chip");
      chips.forEach(chip => {
        if (chip.dataset.series === seriesKey) {
          chip.classList.add("active");
        } else {
          chip.classList.remove("active");
        }
      });

      renderSeasonRow();
      renderEpisodeStrip();

      const consoleTitle = document.getElementById("console-title");
      const consoleSub = document.getElementById("console-sub");
      const metaRow = document.getElementById("episode-meta");
      const summary = document.getElementById("episode-summary");
      const storyStack = document.getElementById("episode-story");
      const chipKey = document.getElementById("chip-key");
      const chipGuest = document.getElementById("chip-guest");
      const chipAnt = document.getElementById("chip-ant");
      const ethicalList = document.getElementById("ethical-list");
      const notesBlock = document.getElementById("notes-block");

      if (consoleTitle) {
        consoleTitle.textContent = "No episode selected";
      }
      if (consoleSub) {
        consoleSub.textContent = "Series " + seriesKey + " loaded. Choose a season, then an episode.";
      }
      if (metaRow) {
        metaRow.innerHTML = "";
      }
      if (summary) {
        summary.innerHTML = "";
        const p = document.createElement("div");
        p.className = "placeholder";
        p.textContent = "Select a season, then an episode, to view its structure.";
        summary.appendChild(p);
      }
      if (storyStack) {
        storyStack.innerHTML = "";
      }
      if (chipKey) {
        chipKey.innerHTML = "";
      }
      if (chipGuest) {
        chipGuest.innerHTML = "";
      }
      if (chipAnt) {
        chipAnt.innerHTML = "";
      }
      if (ethicalList) {
        ethicalList.innerHTML = "";
      }
      if (notesBlock) {
        notesBlock.innerHTML = "";
      }

      const status = document.getElementById("series-status");
      if (status) {
        status.textContent = "Series " + seriesKey + " selected.";
      }

      showPage("episodes");
    }

    function renderSeasonRow() {
      const row = document.getElementById("season-row");
      const subtitle = document.getElementById("episodes-panel-subtitle");
      if (!row) {
        return;
      }
      row.innerHTML = "";

      if (!currentSeries) {
        if (subtitle) {
          subtitle.textContent = "Select a series to view seasons.";
        }
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "Select a series above to view seasons.";
        row.appendChild(div);
        return;
      }

      const seriesEpisodes = episodesBySeries[currentSeries] || [];
      const seasonSet = new Set();
      seriesEpisodes.forEach(ep => {
        if (typeof ep.Season === "number") {
          seasonSet.add(ep.Season);
        }
      });
      const seasons = Array.from(seasonSet).sort((a, b) => a - b);

      if (seasons.length === 0) {
        if (subtitle) {
          subtitle.textContent = "No seasons found for " + currentSeries + ".";
        }
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "No seasons found for this series.";
        row.appendChild(div);
        return;
      }

      seasons.forEach(seasonNumber => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "season-chip" + (seasonNumber === currentSeason ? " active" : "");
        btn.dataset.season = String(seasonNumber);
        btn.textContent = "Season " + seasonNumber;
        btn.addEventListener("click", () => selectSeason(seasonNumber));
        row.appendChild(btn);
      });

      if (subtitle) {
        if (currentSeason === null) {
          subtitle.textContent = "Series " + currentSeries + " – choose a season.";
        } else {
          subtitle.textContent = "Series " + currentSeries + " • Season " + currentSeason;
        }
      }
    }

    function selectSeason(seasonNumber) {
      currentSeason = seasonNumber;
      currentEpisodeID = null;
      renderSeasonRow();
      renderEpisodeStrip();

      const consoleTitle = document.getElementById("console-title");
      const consoleSub = document.getElementById("console-sub");
      const metaRow = document.getElementById("episode-meta");
      const summary = document.getElementById("episode-summary");
      const storyStack = document.getElementById("episode-story");
      const chipKey = document.getElementById("chip-key");
      const chipGuest = document.getElementById("chip-guest");
      const chipAnt = document.getElementById("chip-ant");
      const ethicalList = document.getElementById("ethical-list");
      const notesBlock = document.getElementById("notes-block");

      if (consoleTitle) {
        consoleTitle.textContent = "No episode selected";
      }
      if (consoleSub) {
        consoleSub.textContent = "Season " + seasonNumber + " loaded. Choose an episode.";
      }
      if (metaRow) {
        metaRow.innerHTML = "";
      }
      if (summary) {
        summary.innerHTML = "";
        const p = document.createElement("div");
        p.className = "placeholder";
        p.textContent = "Select an episode from this season to view its structure.";
        summary.appendChild(p);
      }
      if (storyStack) {
        storyStack.innerHTML = "";
      }
      if (chipKey) {
        chipKey.innerHTML = "";
      }
      if (chipGuest) {
        chipGuest.innerHTML = "";
      }
      if (chipAnt) {
        chipAnt.innerHTML = "";
      }
      if (ethicalList) {
        ethicalList.innerHTML = "";
      }
      if (notesBlock) {
        notesBlock.innerHTML = "";
      }
    }

    function renderEpisodeStrip() {
      const strip = document.getElementById("episodes-strip");
      if (!strip) {
        return;
      }
      strip.innerHTML = "";

      if (!currentSeries) {
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "Select a series above to view episodes.";
        strip.appendChild(div);
        return;
      }

      if (currentSeason === null) {
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "Select a season to view episodes.";
        strip.appendChild(div);
        return;
      }

      const allEpisodes = episodesBySeries[currentSeries] || [];
      const seriesEpisodes = allEpisodes.filter(ep => ep.Season === currentSeason);

      if (seriesEpisodes.length === 0) {
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "No episodes found for this season.";
        strip.appendChild(div);
        return;
      }

      seriesEpisodes.forEach(ep => {
        const card = document.createElement("div");
        card.className = "episode-card";
        card.dataset.id = ep.ID;

        const line1 = document.createElement("div");
        line1.className = "episode-line-1";
        line1.textContent = "S" + ep.Season + "E" + ep.Episode + " – " + ep.Title;

        const line2 = document.createElement("div");
        line2.className = "episode-line-2";

        const tag = document.createElement("div");
        tag.className = "episode-tag";
        tag.textContent = ep.Series || "";

        const meta = document.createElement("div");
        meta.className = "episode-meta";
        meta.textContent = ep.StardateOrYear || ep.AirDate || "";

        line2.appendChild(tag);
        line2.appendChild(meta);

        card.appendChild(line1);
        card.appendChild(line2);

        card.addEventListener("click", () => selectEpisode(ep.ID));

        strip.appendChild(card);
      });
    }

    function selectEpisode(id) {
      currentEpisodeID = id;
      const seriesEpisodes = episodesBySeries[currentSeries] || [];
      const episode = seriesEpisodes.find(e => e.ID === id);
      if (!episode) {
        return;
      }

      if (typeof episode.Season === "number" && currentSeason !== episode.Season) {
        currentSeason = episode.Season;
        renderSeasonRow();
        renderEpisodeStrip();
      }

      const cards = document.querySelectorAll(".episode-card");
      cards.forEach(card => {
        if (card.dataset.id === id) {
          card.classList.add("active");
        } else {
          card.classList.remove("active");
        }
      });

      renderEpisodeDetail(episode);
      showPage("details");
    }

    function makeCharacterChip(name) {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = name;
      chip.addEventListener("click", () => openBioModal(name));
      return chip;
    }

    function renderEpisodeDetail(ep) {
      const consoleTitle = document.getElementById("console-title");
      const consoleSub = document.getElementById("console-sub");
      const metaRow = document.getElementById("episode-meta");
      const summary = document.getElementById("episode-summary");
      const storyStack = document.getElementById("episode-story");
      const chipKey = document.getElementById("chip-key");
      const chipGuest = document.getElementById("chip-guest");
      const chipAnt = document.getElementById("chip-ant");
      const ethicalBlock = document.getElementById("ethical-block");
      const ethicalList = document.getElementById("ethical-list");
      const notesBlock = document.getElementById("notes-block");

      if (consoleTitle) {
        consoleTitle.textContent = ep.Series + " • S" + ep.Season + "E" + ep.Episode;
      }
      if (consoleSub) {
        consoleSub.textContent = ep.Title || "";
      }
      if (metaRow) {
        metaRow.innerHTML = "";
        function addMeta(label, value) {
          if (value === undefined || value === null || value === "") {
            return;
          }
          const chip = document.createElement("div");
          chip.className = "meta-chip";
          const spanLabel = document.createElement("span");
          spanLabel.className = "meta-label";
          spanLabel.textContent = label;
          const spanValue = document.createElement("span");
          spanValue.className = "meta-value";
          spanValue.textContent = value;
          chip.appendChild(spanLabel);
          chip.appendChild(spanValue);
          metaRow.appendChild(chip);
        }
        addMeta("ID", ep.ID);
        addMeta("Prod", ep.ProductionCode);
        addMeta("Air date", ep.AirDate);
        addMeta("Stardate/Year", ep.StardateOrYear);
      }
      if (summary) {
        summary.innerHTML = "";
        const text = document.createElement("div");
        text.className = "summary";
        const entry = (summariesById && ep.ID) ? summariesById[ep.ID] : null;
        const summaryText = (entry && entry.Summary) || ep.OneLineSummary || "";
        text.textContent = summaryText;
        summary.appendChild(text);
      }
      if (storyStack) {
        storyStack.innerHTML = "";
        (ep.StorySections || []).forEach(section => {
          const card = document.createElement("article");
          card.className = "story-card";
          const h = document.createElement("h3");
          h.textContent = section.Header;
          const p = document.createElement("p");
          p.textContent = section.Text;
          card.appendChild(h);
          card.appendChild(p);
          storyStack.appendChild(card);
        });
      }
      if (chipKey) {
        chipKey.innerHTML = "";
        (ep.KeyCharacters || []).forEach(name => {
          chipKey.appendChild(makeCharacterChip(name));
        });
      }
      if (chipGuest) {
        chipGuest.innerHTML = "";
        (ep.GuestCharacters || []).forEach(name => {
          chipGuest.appendChild(makeCharacterChip(name));
        });
      }
      if (chipAnt) {
        chipAnt.innerHTML = "";
        (ep.Antagonists || []).forEach(name => {
          chipAnt.appendChild(makeCharacterChip(name));
        });
      }
      const ethics = ep.EthicalIssues || [];
      if (ethicalBlock && ethicalList) {
        ethicalList.innerHTML = "";
        if (ethics.length === 0) {
          ethicalBlock.style.display = "none";
        } else {
          ethicalBlock.style.display = "block";
          ethics.forEach(text => {
            const li = document.createElement("li");
            li.textContent = "• " + text;
            ethicalList.appendChild(li);
          });
        }
      }
      if (notesBlock) {
        notesBlock.innerHTML = "";
        const continuity = ep.ContinuityNotes || [];
        const themes = ep.ThematicNotes || [];
        const bts = ep.BehindTheScenes || [];
        if (continuity.length > 0) {
          const label = document.createElement("div");
          label.className = "block-label block-label-accent";
          label.textContent = "Continuity Notes";
          notesBlock.appendChild(label);
          continuity.forEach(note => {
            const card = document.createElement("article");
            card.className = "note-card";
            const h = document.createElement("h4");
            h.textContent = note.Header;
            const p = document.createElement("p");
            p.textContent = note.Text;
            card.appendChild(h);
            card.appendChild(p);
            notesBlock.appendChild(card);
          });
        }
        if (themes.length > 0) {
          const label = document.createElement("div");
          label.className = "block-label block-label-accent";
          label.textContent = "Themes";
          notesBlock.appendChild(label);
          themes.forEach(note => {
            const card = document.createElement("article");
            card.className = "note-card";
            const h = document.createElement("h4");
            h.textContent = note.Header;
            const p = document.createElement("p");
            p.textContent = note.Text;
            card.appendChild(h);
            card.appendChild(p);
            notesBlock.appendChild(card);
          });
        }
        if (bts.length > 0) {
          const label = document.createElement("div");
          label.className = "block-label block-label-accent";
          label.textContent = "Behind the Scenes";
          notesBlock.appendChild(label);
          bts.forEach(note => {
            const card = document.createElement("article");
            card.className = "note-card";
            const h = document.createElement("h4");
            h.textContent = note.Header;
            const p = document.createElement("p");
            p.textContent = note.Text;
            card.appendChild(h);
            card.appendChild(p);
            notesBlock.appendChild(card);
          });
        }
      }
    }

    function showEpisodesError(message) {
      const subtitle = document.getElementById("episodes-panel-subtitle");
      if (subtitle) {
        subtitle.textContent = "Error loading data";
      }
      const strip = document.getElementById("episodes-strip");
      if (strip) {
        strip.innerHTML = "";
        const div = document.createElement("div");
        div.className = "error-text";
        div.textContent = message;
        strip.appendChild(div);
      }
      const status = document.getElementById("series-status");
      if (status) {
        status.textContent = "Error loading episode data.";
      }
    }

    function fetchEpisodes() {
      const entries = Object.entries(EPISODE_URLS || {});
      if (!entries.length) {
        showEpisodesError("No episode URLs configured.");
        return;
      }

      const requests = entries.map(([seriesKey, url]) =>
        fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error("HTTP " + response.status + " when fetching episode data for " + seriesKey + ".");
            }
            return response.json();
          })
          .then(data => {
            if (!Array.isArray(data)) {
              throw new Error("Expected an array of episodes in the JSON file for " + seriesKey + ".");
            }
            return data;
          })
          .catch(err => {
            console.error("Error loading episodes for", seriesKey + ":", err);
            return [];
          })
      );

      Promise.all(requests)
        .then(results => {
          allEpisodes = [];
          results.forEach(arr => {
            if (Array.isArray(arr)) {
              allEpisodes = allEpisodes.concat(arr);
            }
          });

          if (!allEpisodes.length) {
            showEpisodesError("No episode data loaded.");
            return;
          }

          episodesBySeries = groupEpisodesBySeries(allEpisodes);
          buildSearchIndex();
          const subtitle = document.getElementById("episodes-panel-subtitle");
          if (subtitle) {
            subtitle.textContent = "Data loaded (" + allEpisodes.length + " episode(s))";
          }
          renderSeriesStrip();
        })
        .catch(err => {
          showEpisodesError(err.message);
        });
    }
    function fetchSummaries() {
      return fetch(SUMMARY_URL)
        .then(resp => {
          if (!resp.ok) {
            throw new Error("Failed to fetch summaries: " + resp.status);
          }
          return resp.json();
        })
        .then(data => {
          const map = {};
          (data || []).forEach(entry => {
            if (entry && entry.ID) {
              map[entry.ID] = entry;
            }
          });
          summariesById = map;
        })
        .catch(err => {
          console.error("Error loading summaries", err);
          summariesById = {};
        });
    }


    function fetchBios() {
      fetch(BIO_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error("HTTP " + response.status + " when fetching summaries.");
          }
          return response.json();
        })
        .then(data => {
          biosByKey = {};
          if (Array.isArray(data)) {
            data.forEach(bio => {
              if (bio.Name) {
                const mainKey = bio.Name.toLowerCase();
                biosByKey[mainKey] = bio;
              }
              (bio.Alias || []).forEach(alias => {
                const key = alias.toLowerCase();
                biosByKey[key] = bio;
              });
            });
            biosLoaded = true;
          }
        })
        .catch(err => {
          biosLoaded = false;
          console.error("Error loading summaries:", err);
        });
    }

    function initBioModal() {
      const modal = document.getElementById("bio-modal");
      const backdrop = document.getElementById("bio-backdrop");
      const closeBtn = document.getElementById("bio-close");
      function close() {
        modal.classList.remove("active");
      }
      backdrop.addEventListener("click", close);
      closeBtn.addEventListener("click", close);
      document.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          close();
        }
      });
    }

    function openBioModal(name) {
      const modal = document.getElementById("bio-modal");
      const nameEl = document.getElementById("bio-name");
      const roleEl = document.getElementById("bio-role");
      const summaryEl = document.getElementById("bio-summary");
      const fallbackWrapper = document.getElementById("bio-fallback");
      const fallbackName = document.getElementById("bio-name-raw");

      const key = name.toLowerCase();
      const bio = biosByKey[key];

      if (!biosLoaded) {
        nameEl.textContent = name;
        roleEl.textContent = "";
        summaryEl.textContent = "Summary data is not loaded or unavailable.";
        fallbackWrapper.style.display = "none";
      } else if (!bio) {
        nameEl.textContent = "No summary available";
        roleEl.textContent = "";
        summaryEl.textContent = "There is currently no summary entry for this name in the summaries JSON.";
        fallbackWrapper.style.display = "block";
        fallbackName.textContent = name;
      } else {
        nameEl.textContent = bio.Name || name;
        roleEl.textContent = bio.Role || "";
        summaryEl.textContent = bio.Summary || "";
        fallbackWrapper.style.display = "none";
      }

      modal.classList.add("active");
    }

    function init() {
      initBioModal();
      fetchEpisodes();
      fetchBios();
      fetchSummaries();
      showPage("series");

      const backBtn = document.getElementById("back-to-series");
      if (backBtn) {
        backBtn.addEventListener("click", () => {
          currentEpisodeID = null;
          showPage("series");
        });
      }

      const detailBackEpisodes = document.getElementById("detail-back-episodes");
      if (detailBackEpisodes) {
        detailBackEpisodes.addEventListener("click", () => {
          if (currentSeries) {
            showPage("episodes");
          } else {
            showPage("series");
          }
        });
      }

      const detailBackSeries = document.getElementById("detail-back-series");
      if (detailBackSeries) {
        detailBackSeries.addEventListener("click", () => {
          currentEpisodeID = null;
          showPage("series");
        });
      }

      const searchInput = document.getElementById("search-input");
      if (searchInput) {
        searchInput.addEventListener("input", handleSearchInput);
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
